---
title: "Transaction Weight Calibration Visualized"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("transaction_weights_calibration.R")
library(tidyverse)

cutsAsVec <- function(x) {
  ret <- c("Cut Points:")
  for (row in rownames(x)) {
    cutPoints <- round(x[row, ], digits = 1)
    ret <- c(ret, paste(row,":", paste(cutPoints, collapse = ", ")))
  }
  ret
}
```
Combined Data Effort Values
```{r combined}
combined <- combineData("./Transaction Data")
effort <- read.csv("effortValues.csv")
rownames(effort) <- effort$Project
effort$Project <- NULL
ggplot(combined, aes(x=TL)) + 
  geom_histogram(aes(y = ..density..), binwidth=1, colour="black", fill="white") + 
  stat_function(fun = dnorm, args = list(mean = mean(combined$TL), sd(combined$TL))) + 
  xlab("TL") + ggtitle("Combined TL Data Summary")

ggplot(combined, aes(x=TD)) + 
  geom_histogram(aes(y = ..density..), binwidth=1, colour="black", fill="white") + 
  stat_function(fun = dnorm, args = list(mean = mean(combined$TD), sd(combined$TD))) + 
  xlab("TD") + ggtitle("Combined TD Data Summary")

ggplot(combined, aes(x=DETs)) + 
  geom_histogram(aes(y = ..density..), binwidth=1, colour="black", fill="white") + 
  stat_function(fun = dnorm, args = list(mean = mean(combined$DETs), sd(combined$DETs))) + 
  xlab("DETs") + ggtitle("Combined DETs Data Summary")

```
SWTI Search Results
```{r swti}
SWTIresults <- performSearch(6, "./Transaction Data", effort, c("TL"))
# Plot classification results
for (i in 1:length(SWTIresults)) {
  result <- SWTIresults[[i]]
  df <- as.data.frame(t(subset(result$data, select = -c(Effort))))
  g <- ggplot(data = df, aes(x = rownames(df), y = Aggregate)) + 
    geom_bar(stat = "identity") +
    xlab("Category") +
    ggtitle(paste("Classification Results:", i, "bins"))
  cutsVec <- cutsAsVec(result$cuts)
  g <- g + geom_text(data = data.frame(cutsVec), aes(label=cutsVec, col=cutsVec), alpha=0, x=1, y=1) +
  theme(legend.key=element_blank(), legend.title = element_blank()) +
  guides(colour=guide_legend(override.aes=list(size=0)), reverse = TRUE)
  print(g)
}

# Plot predicted vs. actual effort values
predictedValues <- sapply(1:length(SWTIresults), function(i) {
  predicted <- apply(SWTIresults[[i]]$data, 1, function(x) {
    predict.blm(SWTIresults[[i]]$model, newdata = as.data.frame(t(x)))
  })
})
colnames(predictedValues) <- paste(1:length(SWTIresults), "Bins")
predictedValues <- subset(predictedValues, rownames(predictedValues) != "Aggregate")
predictedValues <- cbind(predictedValues, effort)
predictedValues <- as.data.frame(predictedValues)
r2Vals <- apply(subset(predictedValues, select = -Effort), 2, function (x) {
  dat <- data.frame(Predicted = x, Effort = predictedValues$Effort)
  model <- lm(Effort ~ ., data = dat)
  summary(model)$r.squared
})
r2Vals <- round(r2Vals, digits = 5)
r2Vals <- paste("r2:", r2Vals, sep = "")
predictedValues <- gather(predictedValues, numBins, Predicted, -Effort)
r2data_txt <- data.frame(label = as.character(r2Vals), numBins = paste(1:length(SWTIresults), "Bins"))
ggplot(predictedValues, aes(x = Predicted, y = Effort)) +
  geom_point(shape = 1) + stat_smooth(method = "lm",  se = FALSE, fullrange = TRUE) +
  facet_grid(. ~ numBins) + xlab("Predicted Effort") +
  ylab("Actual Effort") + ggtitle("Model Accuracy") +
  theme(panel.spacing = unit(1, "lines")) +
  geom_text(data = r2data_txt, size = 3, mapping = aes(x = -Inf, y = -Inf, label = label),
            hjust = -0.1, vjust = -1)

# Plot cross validation results
MSEdata <- data.frame(NumBins = 1:length(SWTIresults), MSE = sapply(SWTIresults, function(x) { x$MSE }))
MMREdata <- data.frame(NumBins = 1:length(SWTIresults), MMRE = sapply(SWTIresults, function(x) { x$MMRE }))
PREDdata <- data.frame(NumBins = 1:length(SWTIresults), PRED = sapply(SWTIresults, function(x) { x$PRED }))
ggplot(data = MSEdata, aes(x = NumBins, y = log(MSE))) + geom_point(shape = 1) + geom_line() + ggtitle("MSE Results")
ggplot(data = MMREdata, aes(x = NumBins, y = MMRE)) + geom_point(shape = 1) + geom_line() + ggtitle("MMRE Results")
ggplot(data = PREDdata, aes(x = NumBins, y = PRED)) + geom_point(shape = 1) + geom_line() + ylab("PRED(0.25)") + ggtitle("PRED(0.25) Results")

# Plot marginal posteriors for each parameter
for (i in 1:length(SWTIresults)) {
  marginalData <- SWTIresults[[i]]$model[, !names(SWTIresults[[i]]$model) %in% c("(Intercept)", "sigma")]
  if (is.vector(marginalData)) {
    marginalData <- data.frame(l1 = marginalData)
  }
  for (col in names(marginalData)) {
    mean <- mean(marginalData[, col])
    sd <- sd(marginalData[, col])
    peakDensity <- dnorm(mean, mean, sd)
    g <- ggplot(marginalData, aes(x=marginalData[, col])) + 
    geom_histogram(aes(y = ..density..), binwidth = 1, colour="black", fill="white") + 
    stat_function(fun = dnorm, args = list(mean = mean(mean), sd = sd)) + 
    xlab(col) + ggtitle("Posterior Weight", paste(col, i, "bins")) +
    annotate("text", x = mean, y = peakDensity * ((sd/3 *.1) + 1), label = paste("mean:", round(mean,2),",", "sd:", round(sd,2)))
    print(g)
  }
}
```
SWTII Search Results
```{r swtii, warning = FALSE}
SWTIIresults <- performSearch(5, "./Transaction Data", effort, c("TL", "TD"))
# Plot classification results
for (i in 1:length(SWTIIresults)) {
  result <- SWTIIresults[[i]]
  df <- as.data.frame(t(subset(result$data, select = -c(Effort))))
  g <- ggplot(data = df, aes(x = rownames(df), y = Aggregate)) + 
    geom_bar(stat = "identity") +
    xlab("Category") +
    ggtitle(paste("Classification Results:", i, "bins")) +
    theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
  cutsVec <- cutsAsVec(result$cuts)
  g <- g + geom_text(data = data.frame(cutsVec), aes(label=cutsVec, col=cutsVec), alpha=0, x=1, y=1) +
  theme(legend.key=element_blank(), legend.title = element_blank()) +
  guides(colour=guide_legend(override.aes=list(size=0)), reverse = TRUE)
  print(g)
}

# Plot predicted vs. actual effort values
predictedValues <- sapply(1:length(SWTIIresults), function(i) {
  predicted <- apply(SWTIIresults[[i]]$data, 1, function(x) {
    predict.blm(SWTIIresults[[i]]$model, newdata = as.data.frame(t(x)))
  })
})
colnames(predictedValues) <- paste(1:length(SWTIIresults), "Bins")
predictedValues <- subset(predictedValues, rownames(predictedValues) != "Aggregate")
predictedValues <- cbind(predictedValues, effort)
predictedValues <- as.data.frame(predictedValues)
r2Vals <- apply(subset(predictedValues, select = -Effort), 2, function (x) {
  dat <- data.frame(Predicted = x, Effort = predictedValues$Effort)
  model <- lm(Effort ~ ., data = dat)
  summary(model)$r.squared
})
r2Vals <- round(r2Vals, digits = 5)
r2Vals <- paste("r2:", r2Vals, sep = "")
predictedValues <- gather(predictedValues, numBins, Predicted, -Effort)
r2data_txt <- data.frame(label = as.character(r2Vals), numBins = paste(1:length(SWTIIresults), "Bins"))
ggplot(predictedValues, aes(x = Predicted, y = Effort)) +
  geom_point(shape = 1) + stat_smooth(method = "lm",  se = FALSE, fullrange = TRUE) +
  facet_grid(. ~ numBins) + xlab("Predicted Effort") +
  ylab("Actual Effort") + ggtitle("Model Accuracy") +
  theme(panel.spacing = unit(1, "lines")) +
  geom_text(data = r2data_txt, size = 3, mapping = aes(x = -Inf, y = -Inf, label = label),
            hjust = -0.1, vjust = -1)

# Plots cross validation results  
MSEdata <- data.frame(NumBins = 1:length(SWTIIresults), MSE = sapply(SWTIIresults, function(x) { x$MSE }))
MMREdata <- data.frame(NumBins = 1:length(SWTIIresults), MMRE = sapply(SWTIIresults, function(x) { x$MMRE }))
PREDdata <- data.frame(NumBins = 1:length(SWTIIresults), PRED = sapply(SWTIIresults, function(x) { x$PRED }))
ggplot(data = MSEdata, aes(x = NumBins, y = log(MSE))) + geom_point(shape = 1) + geom_line() + ggtitle("MSE Results")
ggplot(data = MMREdata, aes(x = NumBins, y = MMRE)) + geom_point(shape = 1) + geom_line() + ggtitle("MMRE Results")
ggplot(data = PREDdata, aes(x = NumBins, y = PRED)) + geom_point(shape = 1) + geom_line() + ylab("PRED(0.25)") + ggtitle("PRED(0.25) Results")

# Plot marginal posteriors for each parameter
for (i in 1:length(SWTIIresults)) {
  marginalData <- SWTIIresults[[i]]$model[, !names(SWTIIresults[[i]]$model) %in% c("(Intercept)", "sigma")]
  if (is.vector(marginalData)) {
    marginalData <- data.frame(l1 = marginalData)
  }
  for (col in names(marginalData)) {
    mean <- mean(marginalData[, col])
    sd <- sd(marginalData[, col])
    peakDensity <- dnorm(mean, mean, sd)
    g <- ggplot(marginalData, aes(x=marginalData[, col])) + 
    geom_histogram(aes(y = ..density..), binwidth = 1, colour="black", fill="white") + 
    stat_function(fun = dnorm, args = list(mean = mean(mean), sd = sd)) + 
    xlab(col) + ggtitle("Posterior Weight", paste(col, i, "bins")) +
    annotate("text", x = mean, y = peakDensity * ((sd/3 *.1) + 1), label = paste("mean:", round(mean,2),",", "sd:", round(sd,2)))
    print(g)
  }
}
```
SWTIII Search Results
```{r swtiii, warning = FALSE}
SWTIIIresults <- performSearch(2, "./Transaction Data", effort, c("TL", "TD", "DETs"))
# Plot classification results
for (i in 1:length(SWTIIIresults)) {
  result <- SWTIIIresults[[i]]
  df <- as.data.frame(t(subset(result$data, select = -c(Effort))))
  g <- ggplot(data = df, aes(x = rownames(df), y = Aggregate)) + 
    geom_bar(stat = "identity") +
    xlab("Category") +
    ggtitle(paste("Classification Results:", i, "bins")) +
    theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
  cutsVec <- cutsAsVec(result$cuts)
  g <- g + geom_text(data = data.frame(cutsVec), aes(label=cutsVec, col=cutsVec), alpha=0, x=1, y=1) +
  theme(legend.key=element_blank(), legend.title = element_blank()) +
  guides(colour=guide_legend(override.aes=list(size=0)), reverse = TRUE)
  print(g)
}

# Plot predicted vs. actual effort values
predictedValues <- sapply(1:length(SWTIIIresults), function(i) {
  predicted <- apply(SWTIIIresults[[i]]$data, 1, function(x) {
    predict.blm(SWTIIIresults[[i]]$model, newdata = as.data.frame(t(x)))
  })
})
colnames(predictedValues) <- paste(1:length(SWTIIIresults), "Bins")
predictedValues <- subset(predictedValues, rownames(predictedValues) != "Aggregate")
predictedValues <- cbind(predictedValues, effort)
predictedValues <- as.data.frame(predictedValues)
r2Vals <- apply(subset(predictedValues, select = -Effort), 2, function (x) {
  dat <- data.frame(Predicted = x, Effort = predictedValues$Effort)
  model <- lm(Effort ~ ., data = dat)
  summary(model)$r.squared
})
r2Vals <- round(r2Vals, digits = 5)
r2Vals <- paste("r2:", r2Vals, sep = "")
predictedValues <- gather(predictedValues, numBins, Predicted, -Effort)
r2data_txt <- data.frame(label = as.character(r2Vals), numBins = paste(1:length(SWTIIIresults), "Bins"))
ggplot(predictedValues, aes(x = Predicted, y = Effort)) +
  geom_point(shape = 1) + stat_smooth(method = "lm",  se = FALSE, fullrange = TRUE) +
  facet_grid(. ~ numBins) + xlab("Predicted Effort") +
  ylab("Actual Effort") + ggtitle("Model Accuracy") +
  theme(panel.spacing = unit(1, "lines")) +
  geom_text(data = r2data_txt, size = 3, mapping = aes(x = -Inf, y = -Inf, label = label),
            hjust = -0.1, vjust = -1)

# Plots cross validation results
MSEdata <- data.frame(NumBins = 1:length(SWTIIIresults), MSE = sapply(SWTIIIresults, function(x) { x$MSE }))
MMREdata <- data.frame(NumBins = 1:length(SWTIIIresults), MMRE = sapply(SWTIIIresults, function(x) { x$MMRE }))
PREDdata <- data.frame(NumBins = 1:length(SWTIIIresults), PRED = sapply(SWTIIIresults, function(x) { x$PRED }))
ggplot(data = MSEdata, aes(x = NumBins, y = log(MSE))) + geom_point(shape = 1) + geom_line() + ggtitle("MSE Results")
ggplot(data = MMREdata, aes(x = NumBins, y = MMRE)) + geom_point(shape = 1) + geom_line() + ggtitle("MMRE Results")
ggplot(data = PREDdata, aes(x = NumBins, y = PRED)) + geom_point(shape = 1) + geom_line() + ylab("PRED(0.25)") + ggtitle("PRED Results")

# Plot marginal posteriors for each parameter
for (i in 1:length(SWTIIIresults)) {
  marginalData <- SWTIIIresults[[i]]$model[, !names(SWTIIIresults[[i]]$model) %in% c("(Intercept)", "sigma")]
  if (is.vector(marginalData)) {
    marginalData <- data.frame(TL1TD1DETs1 = marginalData)
  }
  for (col in names(marginalData)) {
    mean <- mean(marginalData[, col])
    sd <- sd(marginalData[, col])
    peakDensity <- dnorm(mean, mean, sd)
    g <- ggplot(marginalData, aes(x=marginalData[, col])) + 
    geom_histogram(aes(y = ..density..), binwidth = 1, colour="black", fill="white") + 
    stat_function(fun = dnorm, args = list(mean = mean(mean), sd = sd)) + 
    xlab(col) + ggtitle(paste("Posterior Weight", col, i, "bins")) +
    annotate("text", x = mean, y = peakDensity * ((sd/3 *.1) + 1), label = paste("mean:", round(mean,2),",", "sd:", round(sd,2)))
    print(g)
  }
}
```